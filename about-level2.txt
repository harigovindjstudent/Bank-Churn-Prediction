# Update User Profile
@profile_bp.route("/update", methods=["PUT"])
@token_required
def update_profile(decoded):
    """
    Update current user's profile fields dynamically.
    Only allows editing of basic info (not role or approval).
    """
    try:
        data = request.get_json(force=True, silent=True) or {}
        user = User.query.get(decoded.get("user_id"))

        if not user:
            return jsonify({"status": "error", "message": "User not found"}), 404

        editable_fields = [
            "full_name", "username", "email", "contact",
            "address", "city", "state", "pincode"
        ]

        updated_fields = 0
        for field in editable_fields:
            if field in data and hasattr(user, field):
                setattr(user, field, data[field])
                updated_fields += 1

        if updated_fields == 0:
            return jsonify({"status": "error", "message": "No valid fields to update."}), 400

        db.session.commit()

        return jsonify({
            "status": "success",
            "message": "Profile updated successfully!",
            "updated_fields": updated_fields
        }), 200

    except Exception as e:
        print("[Error - Update Profile]", e)
        db.session.rollback()
        return jsonify({
            "status": "error",
            "message": "Failed to update profile.",
            "error": str(e)
        }), 500